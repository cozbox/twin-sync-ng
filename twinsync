#!/usr/bin/env bash
set -euo pipefail

# TwinSync v0.1
# - Linux only
# - Menu UI using whiptail
# - Local Git "twin repo" with simple system snapshot
# - Optional GitHub integration (creates/links private per-device repo)

TWIN_CONFIG_DIR="${HOME}/.config/twinsync"
TWIN_CONFIG_FILE="${TWIN_CONFIG_DIR}/config"
DEFAULT_TWIN_REPO="${HOME}/twinsync-device"

TWIN_REPO=""
GITHUB_USER=""
GITHUB_TOKEN=""
GITHUB_DEVICE_REPO=""

ensure_whiptail() {
  if ! command -v whiptail >/dev/null 2>&1; then
    echo "TwinSync requires 'whiptail' for its menu UI."
    echo
    echo "On Debian/Ubuntu (and similar) you can install it with:"
    echo "  sudo apt update && sudo apt install -y whiptail"
    exit 1
  fi
}

ensure_git() {
  if ! command -v git >/dev/null 2>&1; then
    whiptail --msgbox "TwinSync requires 'git'.\n\nOn Debian/Ubuntu you can install it with:\n  sudo apt update && sudo apt install -y git" 12 70
    exit 1
  fi
}

ensure_curl() {
  if ! command -v curl >/dev/null 2>&1; then
    whiptail --msgbox "TwinSync needs 'curl' to talk to GitHub.\n\nOn Debian/Ubuntu you can install it with:\n  sudo apt update && sudo apt install -y curl" 14 70
    exit 1
  fi
}

load_config() {
  if [[ -f "$TWIN_CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    . "$TWIN_CONFIG_FILE"
  fi
  if [[ -z "${TWIN_REPO:-}" ]]; then
    TWIN_REPO="$DEFAULT_TWIN_REPO"
  fi
}

save_config() {
  mkdir -p "$TWIN_CONFIG_DIR"
  cat >"$TWIN_CONFIG_FILE" <<EOF
TWIN_REPO="$TWIN_REPO"
GITHUB_USER="${GITHUB_USER:-}"
GITHUB_TOKEN="${GITHUB_TOKEN:-}"
GITHUB_DEVICE_REPO="${GITHUB_DEVICE_REPO:-}"
EOF
}

choose_repo_path() {
  local input
  input=$(whiptail --inputbox "Directory where the local Twin repo will live:" 10 70 "$TWIN_REPO" --title "TwinSync Init" 3>&1 1>&2 2>&3) || return 1
  TWIN_REPO="$input"
}

configure_github() {
  ensure_whiptail
  ensure_curl
  load_config

  if [[ -z "${GITHUB_USER:-}" ]]; then
    GITHUB_USER=$(whiptail --inputbox "GitHub username:" 10 60 "${GITHUB_USER:-}" --title "TwinSync GitHub Setup" 3>&1 1>&2 2>&3) || return 1
  fi

  if [[ -z "${GITHUB_TOKEN:-}" ]]; then
    local msg
    msg="Enter a GitHub personal access token with 'repo' access.\n\nIt will be stored in plain text on this machine at:\n$TWIN_CONFIG_FILE\n\nUse a token you can revoke any time from GitHub settings."
    GITHUB_TOKEN=$(whiptail --passwordbox "$msg" 15 70 --title "TwinSync GitHub Token" 3>&1 1>&2 2>&3) || return 1
  fi

  save_config
}

setup_github_device_remote() {
  ensure_git
  ensure_curl
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized yet.\nRun 'Init / configure twin repo' first." 10 70
    return 1
  fi

  configure_github || return 1

  local default_name
  default_name="${GITHUB_DEVICE_REPO:-twin-$(hostname 2>/dev/null || echo device)}"

  local repo_name
  repo_name=$(whiptail --inputbox "Name for this device's private GitHub repo:" 10 70 "$default_name" --title "TwinSync GitHub Repo Name" 3>&1 1>&2 2>&3) || return 1

  GITHUB_DEVICE_REPO="$repo_name"
  save_config

  local api_url
  api_url="https://api.github.com/user/repos"
  local payload
  payload=$(printf '{"name":"%s","private":true}' "$GITHUB_DEVICE_REPO")

  local http_code
  http_code=$(curl -s -o /tmp/twinsync-create-repo.log -w "%{http_code}" -u "$GITHUB_USER:$GITHUB_TOKEN" "$api_url" -d "$payload")

  if [[ "$http_code" = "201" ]]; then
    : # created
  elif [[ "$http_code" = "422" ]]; then
    : # already exists, that's OK
  else
    whiptail --msgbox "GitHub repo create/link failed.\nHTTP status: $http_code\n\nCheck your GitHub username, token and permissions.\n\nRaw response was saved to /tmp/twinsync-create-repo.log" 16 75
    return 1
  fi

  (
    cd "$TWIN_REPO"
    if git remote | grep -q '^origin$'; then
      git remote remove origin >/dev/null 2>&1 || true
    fi
    git remote add origin "https://github.com/$GITHUB_USER/$GITHUB_DEVICE_REPO.git" 2>/dev/null || true
    git branch -M main >/dev/null 2>&1 || true
  )

  whiptail --msgbox "Linked local twin repo to GitHub:\nhttps://github.com/$GITHUB_USER/$GITHUB_DEVICE_REPO" 12 80
}

init_repo() {
  ensure_whiptail
  ensure_git
  load_config
  choose_repo_path || return

  mkdir -p "$TWIN_REPO"
  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    git init "$TWIN_REPO" >/dev/null
  fi

  save_config

  if whiptail --yesno "Do you want TwinSync to create/link a private GitHub repo for this device and remember your GitHub details so you don't have to enter them each time?" 14 75; then
    setup_github_device_remote || true
  fi

  whiptail --msgbox "Twin repo is set to:\n$TWIN_REPO\n\nThis is a normal Git repository used as this device's twin." 12 75
}

collect_system_info() {
  load_config
  mkdir -p "$TWIN_REPO/system"

  # Basic OS/kernel info
  uname -a >"$TWIN_REPO/system/uname.txt" 2>/dev/null || true

  # Distro info
  if [[ -f /etc/os-release ]]; then
    cp /etc/os-release "$TWIN_REPO/system/os-release"
  fi

  # Package list (Debian/Ubuntu - dpkg)
  if command -v dpkg-query >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/packages"
    dpkg-query -W -f='${Package} ${Version}\n' >"$TWIN_REPO/system/packages/dpkg.txt" 2>/dev/null || true
  fi

  # Systemd services status snapshot
  if command -v systemctl >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/services"
    systemctl list-unit-files --type=service --no-pager >"$TWIN_REPO/system/services/unit-files.txt" 2>/dev/null || true
    systemctl list-units --type=service --no-pager >"$TWIN_REPO/system/services/active-units.txt" 2>/dev/null || true
  fi

  # A tiny log slice (if journalctl exists)
  if command -v journalctl >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/logs"
    journalctl -n 200 --no-pager >"$TWIN_REPO/system/logs/journal-tail.txt" 2>/dev/null || true
  fi
}

snapshot() {
  ensure_whiptail
  ensure_git
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nChoose 'Init / configure twin repo' first." 10 70
    return
  fi

  collect_system_info

  (
    cd "$TWIN_REPO"
    git add .
  )

  local msg
  msg="TwinSync snapshot $(date -Iseconds)"

  if (cd "$TWIN_REPO" && git diff --cached --quiet); then
    whiptail --msgbox "No changes to snapshot.\n\nTwin repo is already up to date." 10 60
    return
  fi

  (
    cd "$TWIN_REPO"
    git commit -m "$msg" >/dev/null 2>&1 || true
  )

  # Try to push if a remote is configured
  local remotes
  remotes=$(cd "$TWIN_REPO" && git remote 2>/dev/null || true)

  if [[ -n "$remotes" ]]; then
    (
      cd "$TWIN_REPO"
      git push >/dev/null 2>&1 || true
    )
    whiptail --msgbox "Snapshot committed locally.\n\nA 'git push' was attempted. If it failed, you can inspect details by running 'git status' and 'git log' inside:\n$TWIN_REPO" 14 75
  else
    whiptail --msgbox "Snapshot committed locally.\n\nNo Git remote is configured yet, so nothing was pushed.\n\nYou can set up GitHub integration from the menu." 14 75
  fi
}

pull_changes() {
  ensure_whiptail
  ensure_git
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nChoose 'Init / configure twin repo' first." 10 70
    return
  fi

  local remotes
  remotes=$(cd "$TWIN_REPO" && git remote 2>/dev/null || true)
  if [[ -z "$remotes" ]]; then
    whiptail --msgbox "No Git remote configured.\n\nUse the GitHub setup option in the menu to create/link a private repo for this device." 14 80
    return
  fi

  (
    cd "$TWIN_REPO"
    git pull --ff-only >/dev/null 2>&1 || true
  )

  whiptail --msgbox "Pulled latest changes from the remote into the twin repo.\n\nIn this v0.1 demo, TwinSync does NOT yet apply any changes back to the system.\n\nPlanner/Applier will go here in later versions." 16 80
}

main_menu() {
  ensure_whiptail
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync" --menu "Choose an action:" 17 76 8 \
      1 "Init / configure local Twin repo" \
      2 "GitHub setup (remember username/token + device repo)" \
      3 "Take snapshot (commit & optional push)" \
      4 "Pull from remote (no apply yet)" \
      5 "Exit" 3>&1 1>&2 2>&3) || exit 0

    case "$choice" in
      1) init_repo ;;
      2) setup_github_device_remote ;;
      3) snapshot ;;
      4) pull_changes ;;
      5) exit 0 ;;
    esac
  done
}

# CLI shortcuts for advanced use
if [[ $# -gt 0 ]]; then
  case "$1" in
    init) init_repo ;;
    push|snapshot) snapshot ;;
    pull) pull_changes ;;
    github-setup) setup_github_device_remote ;;
    *)
      echo "TwinSync v0.1"
      echo "Usage:"
      echo "  $0                # Launch menu UI"
      echo "  $0 init           # Init twin repo (no menu)"
      echo "  $0 push           # Take snapshot (no menu)"
      echo "  $0 pull           # Pull from remote (no apply yet)"
      echo "  $0 github-setup   # GitHub credentials + device repo setup"
      exit 1
      ;;
  esac
else
  main_menu
fi
