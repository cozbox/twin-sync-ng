#!/usr/bin/env bash
set -euo pipefail

# TwinSync v0.3
# - Linux only
# - whiptail menu UI
# - Local Git "twin repo" per device
# - Optional GitHub integration (saves username/token + per-device repo)
# - Collector: system + filesystem (+ startup)
# - Planner/Applier: files, apt packages, systemd services, user crontab
# - Time Machine: choose git snapshot and reset twin repo to it

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TWIN_CONFIG_DIR="${HOME}/.config/twinsync"
TWIN_CONFIG_FILE="${TWIN_CONFIG_DIR}/config"

DEFAULT_TWIN_REPO="${HOME}/twinsync-device"
DEFAULT_FS_ROOTS="/etc ${HOME}/.config"

TWIN_REPO=""
GITHUB_USER=""
GITHUB_TOKEN=""
GITHUB_DEVICE_REPO=""
FS_ROOTS=""

ensure_whiptail() {
  if ! command -v whiptail >/dev/null 2>&1; then
    echo "TwinSync requires 'whiptail' for its menu UI."
    echo
    echo "On Debian/Ubuntu (and similar) you can install it with:"
    echo "  sudo apt update && sudo apt install -y whiptail"
    exit 1
  fi
}

ensure_git() {
  if ! command -v git >/dev/null 2>&1; then
    whiptail --msgbox "TwinSync requires 'git'.\n\nOn Debian/Ubuntu you can install it with:\n  sudo apt update && sudo apt install -y git" 12 70
    exit 1
  fi
}

ensure_curl() {
  if ! command -v curl >/dev/null 2>&1; then
    whiptail --msgbox "TwinSync needs 'curl' to talk to GitHub.\n\nOn Debian/Ubuntu you can install it with:\n  sudo apt update && sudo apt install -y curl" 14 70
    exit 1
  fi
}

load_config() {
  if [[ -f "$TWIN_CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    . "$TWIN_CONFIG_FILE"
  fi
  if [[ -z "${TWIN_REPO:-}" ]]; then
    TWIN_REPO="$DEFAULT_TWIN_REPO"
  fi
  if [[ -z "${FS_ROOTS:-}" ]]; then
    FS_ROOTS="$DEFAULT_FS_ROOTS"
  fi
}

save_config() {
  mkdir -p "$TWIN_CONFIG_DIR"
  local fs
  fs="${FS_ROOTS:-$DEFAULT_FS_ROOTS}"
  cat >"$TWIN_CONFIG_FILE" <<EOF
TWIN_REPO="$TWIN_REPO"
GITHUB_USER="${GITHUB_USER:-}"
GITHUB_TOKEN="${GITHUB_TOKEN:-}"
GITHUB_DEVICE_REPO="${GITHUB_DEVICE_REPO:-}"
FS_ROOTS="$fs"
EOF
}

root_in_list() {
  local needle="$1"
  local haystack="$2"
  local entry
  for entry in $haystack; do
    if [[ "$entry" = "$needle" ]]; then
      return 0
    fi
  done
  return 1
}

discover_root_candidates() {
  # shellcheck disable=SC2034 # referenced via nameref
  local -n _out=$1
  local -A seen=()
  local path
  local -a seeds=(
    "/etc"
    "/usr/local/etc"
    "/usr/local/bin"
    "/var/www"
    "$HOME"
    "$HOME/.config"
    "$HOME/.local"
    "$HOME/.local/share"
    "$HOME/.local/bin"
    "$HOME/.ssh"
    "$HOME/bin"
  )

  for path in "${seeds[@]}"; do
    [[ -d "$path" ]] || continue
    [[ -n "${seen[$path]:-}" ]] && continue
    seen[$path]=1
    _out+=("$path")
  done

  if [[ -d "$HOME" ]]; then
    while IFS= read -r sub; do
      [[ -d "$sub" ]] || continue
      [[ "$sub" == *' '* ]] && continue
      [[ -n "${seen[$sub]:-}" ]] && continue
      seen[$sub]=1
      _out+=("$sub")
    done < <(find "$HOME" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | sort | head -n 15)
  fi
}

configure_filesystem_roots() {
  ensure_whiptail
  load_config

  local current_roots="${FS_ROOTS:-$DEFAULT_FS_ROOTS}"
  local -a candidates=()
  discover_root_candidates candidates

  local -a checklist_args=()
  local candidate
  for candidate in "${candidates[@]}"; do
    local state="OFF"
    if root_in_list "$candidate" "$current_roots"; then
      state="ON"
    fi
    checklist_args+=("$candidate" "$candidate" "$state")
  done

  local selected_text=""
  if ((${#checklist_args[@]} > 0)); then
    if ! selected_text=$(whiptail --separate-output --checklist \
        "Select directories to mirror into the twin repo.\nSpace toggles, Enter accepts.\n\nTwin will store every regular file under 1MB inside these roots." \
        22 90 12 "${checklist_args[@]}" 3>&1 1>&2 2>&3); then
      return
    fi
  fi

  local -a chosen_roots=()
  if [[ -n "$selected_text" ]]; then
    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      chosen_roots+=("$line")
    done <<<"$selected_text"
  fi

  local extra_msg
  extra_msg="Add any other directories (space-separated) to mirror.\nPaths may start with '~'.\nLeave blank to skip."
  local extras=""
  if ! extras=$(whiptail --inputbox "$extra_msg" 14 90 "" --title "Additional filesystem roots" 3>&1 1>&2 2>&3); then
    return
  fi

  if [[ -n "$extras" ]]; then
    local entry
    for entry in $extras; do
      [[ -z "$entry" ]] && continue
      entry="${entry/#\~/$HOME}"
      entry="${entry%/}"
      chosen_roots+=("$entry")
    done
  fi

  if ((${#chosen_roots[@]} == 0)); then
    whiptail --msgbox "No directories selected. Keeping previous value:\n$current_roots" 12 80
    return
  fi

  local -a unique_roots=()
  local -A seen=()
  for candidate in "${chosen_roots[@]}"; do
    [[ -z "$candidate" ]] && continue
    candidate="${candidate%/}"
    [[ -z "$candidate" ]] && continue
    if [[ -n "${seen[$candidate]:-}" ]]; then
      continue
    fi
    seen[$candidate]=1
    unique_roots+=("$candidate")
  done

  local -a valid_roots=()
  local -a invalid_roots=()
  for candidate in "${unique_roots[@]}"; do
    if [[ -d "$candidate" ]]; then
      valid_roots+=("$candidate")
    else
      invalid_roots+=("$candidate")
    fi
  done

  if ((${#valid_roots[@]} == 0)); then
    whiptail --msgbox "All selected directories do not exist. Nothing changed." 12 80
    return
  fi

  FS_ROOTS="${valid_roots[*]}"
  save_config

  local summary
  summary="TwinSync will snapshot these directories:\n"
  summary+="$(printf '%s\n' "${valid_roots[@]}")"
  if ((${#invalid_roots[@]} > 0)); then
    summary+="\nSkipped (not found):\n"
    summary+="$(printf '%s\n' "${invalid_roots[@]}")"
  fi

  whiptail --msgbox "$summary" 20 90
}

choose_repo_path() {
  local input
  input=$(whiptail --inputbox "Directory where the local Twin repo will live:" 10 70 "$TWIN_REPO" --title "TwinSync Init" 3>&1 1>&2 2>&3) || return 1
  TWIN_REPO="$input"
}

install_dependencies() {
  # This is mostly informational because whiptail is already required to get here.
  if command -v git >/dev/null 2>&1 && command -v curl >/dev/null 2>&1 && command -v whiptail >/dev/null 2>&1; then
    whiptail --msgbox "Core dependencies already appear to be installed:\n\n- git\n- curl\n- whiptail" 12 70
    return
  fi

  if ! command -v apt-get >/dev/null 2>&1; then
    whiptail --msgbox "Automatic dependency install is only supported on Debian/Ubuntu (apt-get).\n\nPlease install at least: git, curl, whiptail using your distro's package manager." 14 75
    return
  fi

  local msg
  msg="TwinSync can try to install dependencies using:\n\n  sudo apt-get update\n  sudo apt-get install -y git curl whiptail\n\nRun this now?"
  if ! whiptail --yesno "$msg" 18 80; then
    return
  fi

  if sudo apt-get update && sudo apt-get install -y git curl whiptail; then
    whiptail --msgbox "Dependency install commands finished.\n\nCheck the terminal for any warnings or errors." 14 75
  else
    whiptail --msgbox "Dependency install appears to have failed.\n\nCheck the terminal output for details." 14 75
  fi
}

update_twinsync_program() {
  ensure_whiptail
  ensure_git

  if [[ ! -d "$SCRIPT_DIR/.git" ]]; then
    whiptail --msgbox "TwinSync directory is not a Git checkout.\n\nClone https://github.com/niyisurvey/twin-sync to enable in-place updates." 14 80
    return
  fi

  local dirty
  if (cd "$SCRIPT_DIR" && ! git diff --quiet --ignore-submodules HEAD); then
    dirty=1
  else
    dirty=0
  fi

  if [[ "$dirty" -eq 1 ]]; then
    if ! whiptail --yesno "Local changes detected in the TwinSync directory.\n\nA git pull could overwrite them.\n\nProceed anyway?" 14 80; then
      return
    fi
  fi

  local remote branch tracking
  if tracking=$(cd "$SCRIPT_DIR" && git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null); then
    remote="${tracking%%/*}"
    branch="${tracking#*/}"
  else
    remote="origin"
    if branch=$(cd "$SCRIPT_DIR" && git symbolic-ref --quiet --short "refs/remotes/${remote}/HEAD" 2>/dev/null); then
      branch="${branch#${remote}/}"
    elif (cd "$SCRIPT_DIR" && git show-ref --verify --quiet "refs/remotes/${remote}/main"); then
      branch="main"
    elif (cd "$SCRIPT_DIR" && git show-ref --verify --quiet "refs/remotes/${remote}/master"); then
      branch="master"
    else
      branch=$(cd "$SCRIPT_DIR" && git for-each-ref --format='%(refname:short)' "refs/remotes/${remote}/*" | head -n 1)
    fi
  fi

  if [[ -z "$branch" ]]; then
    whiptail --msgbox "No remote branch detected for updates.\n\nEnsure the TwinSync checkout tracks a remote (e.g. origin/main)." 14 85
    return
    branch=$(cd "$SCRIPT_DIR" && git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
  fi

  if ! (cd "$SCRIPT_DIR" && git remote get-url "$remote" >/dev/null 2>&1); then
    whiptail --msgbox "No Git remote configured for the TwinSync directory.\n\nSet a remote (e.g. origin) to enable in-place updates." 14 90
    return
  fi

  local log_file
  log_file="/tmp/twinsync-update.log"
  {
    echo "TwinSync updater run: $(date)"
    echo "Using remote: $remote"
    echo "Branch target: $branch"
    echo "--- git status (pre) ---"
    git -C "$SCRIPT_DIR" status -sb
    echo "--- git fetch ---"
    git -C "$SCRIPT_DIR" fetch "$remote"
    echo "--- git pull (ff-only) ---"
    git -C "$SCRIPT_DIR" pull --ff-only "$remote" "$branch"
  } >"$log_file" 2>&1

  if grep -q "Fast-forward" "$log_file" || grep -q "Already up to date." "$log_file"; then
    whiptail --msgbox "TwinSync program checked $remote/$branch for updates.\n\nSee $log_file for details." 14 85
  else
    whiptail --msgbox "TwinSync update may not have completed.\n\nReview $log_file for git output, resolve issues, and try again." 14 85
  if (cd "$SCRIPT_DIR" && git fetch "$remote" >/dev/null 2>&1 && git pull --ff-only "$remote" "$branch" >/dev/null 2>"$log_file"); then
    whiptail --msgbox "TwinSync program updated from $remote/$branch.\n\nRestart TwinSync to run the newest version." 14 85
  else
    whiptail --msgbox "TwinSync update failed.\n\nCheck $log_file for git output, resolve any conflicts, and try again." 14 85
  fi
}

show_config() {
  load_config
  local msg
  msg="Current TwinSync config:\n\nTwin repo:\n$TWIN_REPO\n\nGitHub user: ${GITHUB_USER:-<none>}\nGitHub device repo: ${GITHUB_DEVICE_REPO:-<none>}\n\nFilesystem roots mirrored into twin:\n$FS_ROOTS"
  whiptail --msgbox "$msg" 18 80
}

configure_github() {
  ensure_curl
  load_config

  if [[ -z "${GITHUB_USER:-}" ]]; then
    GITHUB_USER=$(whiptail --inputbox "GitHub username:" 10 60 "${GITHUB_USER:-}" --title "TwinSync GitHub Setup" 3>&1 1>&2 2>&3) || return 1
  fi

  if [[ -z "${GITHUB_TOKEN:-}" ]]; then
    local msg
    msg="Enter a GitHub personal access token with 'repo' access.\n\nIt will be stored in plain text on this machine at:\n$TWIN_CONFIG_FILE\n\nUse a token you can revoke any time from GitHub settings."
    GITHUB_TOKEN=$(whiptail --passwordbox "$msg" 16 70 --title "TwinSync GitHub Token" 3>&1 1>&2 2>&3) || return 1
  fi

  save_config
}

setup_github_device_remote() {
  ensure_git
  ensure_curl
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized yet.\nRun 'Init / configure local Twin repo' first." 10 70
    return 1
  fi

  configure_github || return 1

  local default_name
  default_name="${GITHUB_DEVICE_REPO:-twin-$(hostname 2>/dev/null || echo device)}"

  local repo_name
  repo_name=$(whiptail --inputbox "Name for this device's private GitHub repo:" 10 70 "$default_name" --title "TwinSync GitHub Repo Name" 3>&1 1>&2 2>&3) || return 1

  GITHUB_DEVICE_REPO="$repo_name"
  save_config

  local api_url payload http_code
  api_url="https://api.github.com/user/repos"
  payload=$(printf '{"name":"%s","private":true}' "$GITHUB_DEVICE_REPO")

  http_code=$(curl -s -o /tmp/twinsync-create-repo.log -w "%{http_code}" -u "$GITHUB_USER:$GITHUB_TOKEN" "$api_url" -d "$payload")

  if [[ "$http_code" = "201" ]]; then
    :
  elif [[ "$http_code" = "422" ]]; then
    : # already exists
  else
    whiptail --msgbox "GitHub repo create/link failed.\nHTTP status: $http_code\n\nCheck your GitHub username, token and permissions.\n\nRaw response saved to /tmp/twinsync-create-repo.log" 16 75
    return 1
  fi

  (
    cd "$TWIN_REPO"
    if git remote | grep -q '^origin$'; then
      git remote remove origin >/dev/null 2>&1 || true
    fi
    git remote add origin "https://github.com/$GITHUB_USER/$GITHUB_DEVICE_REPO.git" 2>/dev/null || true
    git branch -M main >/dev/null 2>&1 || true
  )

  whiptail --msgbox "Linked local twin repo to GitHub:\nhttps://github.com/$GITHUB_USER/$GITHUB_DEVICE_REPO" 12 80
}

init_repo() {
  ensure_git
  load_config
  choose_repo_path || return

  mkdir -p "$TWIN_REPO"
  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    git init "$TWIN_REPO" >/dev/null
  fi

  save_config

  if whiptail --yesno "Twin repo is set to:\n$TWIN_REPO\n\nDo you want TwinSync to create/link a private GitHub repo for this device and remember your GitHub details?" 16 75; then
    setup_github_device_remote || true
  fi

  whiptail --msgbox "Twin repo is ready at:\n$TWIN_REPO\n\nThis is a normal Git repository used as this device's digital twin." 12 75
}

collect_system_info() {
  load_config
  mkdir -p "$TWIN_REPO/system"

  uname -a >"$TWIN_REPO/system/uname.txt" 2>/dev/null || true

  if [[ -f /etc/os-release ]]; then
    cp /etc/os-release "$TWIN_REPO/system/os-release"
  fi

  if command -v dpkg-query >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/packages"
    dpkg-query -W -f='${Package} ${Version}\n' >"$TWIN_REPO/system/packages/dpkg.txt" 2>/dev/null || true
  fi

  if command -v systemctl >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/services"
    systemctl list-unit-files --type=service --no-pager >"$TWIN_REPO/system/services/unit-files.txt" 2>/dev/null || true
    systemctl list-units --type=service --no-pager >"$TWIN_REPO/system/services/active-units.txt" 2>/dev/null || true

    # Build a desired-state snapshot (service enabled/running) that AI/humans can edit later
    local tmpdir
    tmpdir="$TWIN_REPO/system/services/.tmp-desired"
    rm -rf "$tmpdir"
    mkdir -p "$tmpdir"

    systemctl list-unit-files --type=service --no-pager \
      | awk 'NR>1 && $1 ~ /\.service$/ {print $1" "$2}' >"$tmpdir/enabled.txt" 2>/dev/null || true
    systemctl list-units --type=service --no-pager \
      | awk 'NR>1 && $1 ~ /\.service$/ {print $1" "$3}' >"$tmpdir/running.txt" 2>/dev/null || true

    {
      echo "# service enabled running"
      sort "$tmpdir/enabled.txt" "$tmpdir/running.txt" 2>/dev/null | awk '{print $1}' | sort -u | while read -r name; do
        [[ -z "$name" ]] && continue
        local enabled running
        enabled=$(grep -m1 "^$name " "$tmpdir/enabled.txt" | awk '{print $2}')
        running=$(grep -m1 "^$name " "$tmpdir/running.txt" | awk '{print $2}')
        [[ -z "$enabled" ]] && enabled="disabled"
        [[ -z "$running" ]] && running="inactive"
        echo "$name $enabled $running"
      done
    } >"$TWIN_REPO/system/services/desired-state.txt"

    rm -rf "$tmpdir"
  fi

  if command -v journalctl >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/logs"
    journalctl -n 200 --no-pager >"$TWIN_REPO/system/logs/journal-tail.txt" 2>/dev/null || true
  fi

  # Startup (user crontab snapshot)
  if command -v crontab >/dev/null 2>&1; then
    mkdir -p "$TWIN_REPO/system/startup"
    if crontab -l >/dev/null 2>&1; then
      crontab -l >"$TWIN_REPO/system/startup/user-crontab.txt" 2>/dev/null || true
    fi
  fi
}

collect_filesystem_snapshot() {
  load_config
  mkdir -p "$TWIN_REPO/filesystem"
  local root

  for root in $FS_ROOTS; do
    if [[ ! -d "$root" ]]; then
      continue
    fi
    if [[ "$root" = "/" ]]; then
      continue
    fi
    while IFS= read -r file; do
      local rel dest
      rel="${file#/}"
      dest="$TWIN_REPO/filesystem/$rel"
      mkdir -p "$(dirname "$dest")" 2>/dev/null || true
      cp "$file" "$dest" 2>/dev/null || true
    done < <(find "$root" -type f -size -1024k 2>/dev/null)
  done
}

build_file_plan() {
  load_config
  local plan_file
  plan_file="$TWIN_REPO/plan-files.txt"
  : >"$plan_file"

  if [[ ! -d "$TWIN_REPO/filesystem" ]]; then
    echo "$plan_file 0 0"
    return
  fi

  local twin_file rel sys_path
  local replace_count=0
  local create_count=0

  while IFS= read -r twin_file; do
    rel="${twin_file#"${TWIN_REPO}/filesystem/"}"
    sys_path="/$rel"
    if [[ ! -e "$sys_path" ]]; then
      echo "CREATE $sys_path $twin_file" >>"$plan_file"
      ((create_count++)) || true
    else
      if ! cmp -s "$twin_file" "$sys_path"; then
        echo "REPLACE $sys_path $twin_file" >>"$plan_file"
        ((replace_count++)) || true
      fi
    fi
  done < <(find "$TWIN_REPO/filesystem" -type f 2>/dev/null | sort)

  echo "$plan_file $replace_count $create_count"
}

plan_file_changes() {
  ensure_whiptail
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nChoose 'Setup / utilities' → 'Init / configure local Twin repo' first." 10 80
    return
  fi

  local result plan_file replace_count create_count
  result=$(build_file_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  replace_count=$(echo "$result" | awk '{print $2}')
  create_count=$(echo "$result" | awk '{print $3}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No file differences found between twin and system for the configured roots." 10 75
    return
  fi

  local preview msg
  preview=$(head -n 10 "$plan_file" 2>/dev/null || echo "(plan file has more entries)")

  msg="Planned file changes (twin -> system):\n\nReplace: $replace_count files\nCreate:  $create_count files\n\nRoots being considered:\n$FS_ROOTS\n\nFirst lines of plan-files.txt:\n$preview\n\nFull plan saved at:\n$plan_file"
  whiptail --msgbox "$msg" 20 80
}

apply_file_changes() {
  ensure_whiptail
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nChoose 'Setup / utilities' → 'Init / configure local Twin repo' first." 10 80
    return
  fi

  local result plan_file replace_count create_count
  result=$(build_file_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  replace_count=$(echo "$result" | awk '{print $2}')
  create_count=$(echo "$result" | awk '{print $3}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No file changes to apply.\nTwin and system already match for the configured roots." 10 80
    return
  fi

  local confirm_msg
  confirm_msg="About to apply file changes (twin -> system).\n\nReplace: $replace_count files\nCreate:  $create_count files\n\nBackups will be made as <path>.twinbak-YYYYMMDDHHMMSS before replacements where possible.\n\nIf some target paths are under /etc or other system dirs, you may need to run TwinSync with sudo for this to fully succeed.\n\nApply these file changes now?"

  if ! whiptail --yesno "$confirm_msg" 20 80; then
    return
  fi

  local ok=0 fail=0 action sys_path twin_file

  while read -r action sys_path twin_file; do
    [[ -z "$action" ]] && continue
    if [[ "$action" = "REPLACE" && -e "$sys_path" ]]; then
      local backup
      backup="${sys_path}.twinbak-$(date +%Y%m%d%H%M%S)"
      cp "$sys_path" "$backup" 2>/dev/null || true
    fi
    mkdir -p "$(dirname "$sys_path")" 2>/dev/null || true
    if cp "$twin_file" "$sys_path" 2>/dev/null; then
      ((ok++)) || true
    else
      ((fail++)) || true
    fi
  done <"$plan_file"

  local result_msg
  result_msg="File apply finished.\n\nSucceeded: $ok\nFailed (check permissions/paths): $fail\n\nIf some paths are under system directories (like /etc), re-run TwinSync with higher privileges if needed."
  whiptail --msgbox "$result_msg" 16 80
}

build_package_plan() {
  load_config
  local plan_file desired_file workdir
  plan_file="$TWIN_REPO/plan-packages.txt"
  : >"$plan_file"

  if ! command -v dpkg-query >/dev/null 2>&1; then
    echo "$plan_file 0 0"
    return
  fi

  desired_file="$TWIN_REPO/system/packages/dpkg.txt"
  if [[ ! -f "$desired_file" ]]; then
    echo "$plan_file 0 0"
    return
  fi

  workdir="$TWIN_REPO/.tmp-packages"
  rm -rf "$workdir"
  mkdir -p "$workdir"

  awk '{print $1}' "$desired_file" | sort -u >"$workdir/desired.txt"
  dpkg-query -W -f='${Package}\n' | sort -u >"$workdir/actual.txt" 2>/dev/null || true

  comm -23 "$workdir/desired.txt" "$workdir/actual.txt" | while read -r pkg; do
    [[ -z "$pkg" ]] && continue
    echo "INSTALL $pkg" >>"$plan_file"
  done

  comm -13 "$workdir/desired.txt" "$workdir/actual.txt" | while read -r pkg; do
    [[ -z "$pkg" ]] && continue
    echo "REMOVE $pkg" >>"$plan_file"
  done

  local install_count remove_count
  install_count=$(grep -c '^INSTALL ' "$plan_file" 2>/dev/null || echo 0)
  remove_count=$(grep -c '^REMOVE ' "$plan_file" 2>/dev/null || echo 0)

  rm -rf "$workdir"
  echo "$plan_file $install_count $remove_count"
}

plan_package_changes() {
  ensure_whiptail
  load_config

  local result plan_file install_count remove_count
  result=$(build_package_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  install_count=$(echo "$result" | awk '{print $2}')
  remove_count=$(echo "$result" | awk '{print $3}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No package changes planned.\nTwin and system package lists match (for apt/dpkg)." 10 80
    return
  fi

  local preview msg
  preview=$(head -n 15 "$plan_file" 2>/dev/null || echo "(plan file has more entries)")

  msg="Planned package changes (apt, twin -> system):\n\nInstall: $install_count packages\nRemove:  $remove_count packages\n\nFirst lines of plan-packages.txt:\n$preview\n\nFull plan saved at:\n$plan_file"
  whiptail --msgbox "$msg" 20 80
}

apply_package_changes() {
  ensure_whiptail
  load_config

  if ! command -v apt-get >/dev/null 2>&1; then
    whiptail --msgbox "Package apply currently only supports apt-based systems.\n\nNo changes were applied." 10 80
    return
  fi

  local result plan_file install_count remove_count
  result=$(build_package_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  install_count=$(echo "$result" | awk '{print $2}')
  remove_count=$(echo "$result" | awk '{print $3}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No package changes to apply.\nTwin and system match (for apt/dpkg)." 10 80
    return
  fi

  local confirm_msg
  confirm_msg="About to apply package changes (apt, twin -> system).\n\nInstall: $install_count\nRemove:  $remove_count\n\nThis will run apt-get install/remove commands.\n\nYou may be prompted for your sudo password.\n\nProceed?"
  if ! whiptail --yesno "$confirm_msg" 20 80; then
    return
  fi

  local ok=0 fail=0 action pkg
  while read -r action pkg _; do
    [[ -z "$action" ]] && continue
    if [[ "$action" = "INSTALL" ]]; then
      if sudo apt-get install -y "$pkg"; then
        ((ok++)) || true
      else
        ((fail++)) || true
      fi
    elif [[ "$action" = "REMOVE" ]]; then
      if sudo apt-get remove -y "$pkg"; then
        ((ok++)) || true
      else
        ((fail++)) || true
      fi
    fi
  done <"$plan_file"

  local msg
  msg="Package apply finished.\n\nCommands succeeded: $ok\nCommands failed:    $fail\n\nCheck terminal output for detailed apt messages."
  whiptail --msgbox "$msg" 18 80
}

build_service_plan() {
  load_config
  local plan_file desired_file tmpdir
  plan_file="$TWIN_REPO/plan-services.txt"
  : >"$plan_file"

  if ! command -v systemctl >/dev/null 2>&1; then
    echo "$plan_file 0 0 0 0"
    return
  fi

  desired_file="$TWIN_REPO/system/services/desired-state.txt"
  if [[ ! -f "$desired_file" ]]; then
    echo "$plan_file 0 0 0 0"
    return
  fi

  tmpdir="$TWIN_REPO/system/services/.tmp-plan"
  rm -rf "$tmpdir"
  mkdir -p "$tmpdir"

  systemctl list-unit-files --type=service --no-pager \
    | awk 'NR>1 && $1 ~ /\.service$/ {print $1" "$2}' >"$tmpdir/live-enabled.txt" 2>/dev/null || true
  systemctl list-units --type=service --no-pager \
    | awk 'NR>1 && $1 ~ /\.service$/ {print $1" "$3}' >"$tmpdir/live-running.txt" 2>/dev/null || true

  local enable_count=0 disable_count=0 start_count=0 stop_count=0

  while read -r name enabled running; do
    [[ -z "$name" ]] && continue
    [[ "$name" = "#"* ]] && continue
    local live_enabled live_running
    live_enabled=$(grep -m1 "^$name " "$tmpdir/live-enabled.txt" | awk '{print $2}')
    live_running=$(grep -m1 "^$name " "$tmpdir/live-running.txt" | awk '{print $2}')
    [[ -z "$live_enabled" ]] && live_enabled="disabled"
    [[ -z "$live_running" ]] && live_running="inactive"

    if [[ "$enabled" = "enabled" && "$live_enabled" != "enabled" ]]; then
      echo "ENABLE $name" >>"$plan_file"
      ((enable_count++)) || true
    elif [[ "$enabled" = "disabled" && "$live_enabled" = "enabled" ]]; then
      echo "DISABLE $name" >>"$plan_file"
      ((disable_count++)) || true
    fi

    if [[ "$running" = "running" && "$live_running" != "active" ]]; then
      echo "START $name" >>"$plan_file"
      ((start_count++)) || true
    elif [[ "$running" != "running" && "$live_running" = "active" ]]; then
      echo "STOP $name" >>"$plan_file"
      ((stop_count++)) || true
    fi
  done <"$desired_file"

  rm -rf "$tmpdir"
  echo "$plan_file $enable_count $disable_count $start_count $stop_count"
}

plan_service_changes() {
  ensure_whiptail
  load_config

  local result plan_file ec dc sc tc
  result=$(build_service_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  ec=$(echo "$result" | awk '{print $2}')
  dc=$(echo "$result" | awk '{print $3}')
  sc=$(echo "$result" | awk '{print $4}')
  tc=$(echo "$result" | awk '{print $5}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No service changes planned.\nTwin desired-state and live systemctl state match." 10 80
    return
  fi

  local preview msg
  preview=$(head -n 15 "$plan_file" 2>/dev/null || echo "(plan file has more entries)")
  msg="Planned service changes (systemd, twin -> system):\n\nEnable:  $ec\nDisable: $dc\nStart:   $sc\nStop:    $tc\n\nFirst lines of plan-services.txt:\n$preview\n\nFull plan saved at:\n$plan_file"
  whiptail --msgbox "$msg" 20 80
}

apply_service_changes() {
  ensure_whiptail
  load_config

  if ! command -v systemctl >/dev/null 2>&1; then
    whiptail --msgbox "Service apply requires systemd (systemctl).\n\nNo changes were applied." 10 80
    return
  fi

  local result plan_file ec dc sc tc
  result=$(build_service_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  ec=$(echo "$result" | awk '{print $2}')
  dc=$(echo "$result" | awk '{print $3}')
  sc=$(echo "$result" | awk '{print $4}')
  tc=$(echo "$result" | awk '{print $5}')

  if [[ ! -s "$plan_file" ]]; then
    whiptail --msgbox "No service changes to apply.\nTwin and system match." 10 80
    return
  fi

  local confirm_msg
  confirm_msg="About to apply service changes (systemd, twin -> system).\n\nEnable:  $ec\nDisable: $dc\nStart:   $sc\nStop:    $tc\n\nThis will run systemctl enable/disable/start/stop commands.\n\nProceed?"
  if ! whiptail --yesno "$confirm_msg" 20 80; then
    return
  fi

  local ok=0 fail=0 action svc
  while read -r action svc _; do
    [[ -z "$action" ]] && continue
    if [[ "$action" = "ENABLE" ]]; then
      if sudo systemctl enable "$svc"; then ((ok++)) || true; else ((fail++)) || true; fi
    elif [[ "$action" = "DISABLE" ]]; then
      if sudo systemctl disable "$svc"; then ((ok++)) || true; else ((fail++)) || true; fi
    elif [[ "$action" = "START" ]]; then
      if sudo systemctl start "$svc"; then ((ok++)) || true; else ((fail++)) || true; fi
    elif [[ "$action" = "STOP" ]]; then
      if sudo systemctl stop "$svc"; then ((ok++)) || true; else ((fail++)) || true; fi
    fi
  done <"$plan_file"

  local msg
  msg="Service apply finished.\n\nCommands succeeded: $ok\nCommands failed:    $fail\n\nCheck journalctl/systemctl for details if anything failed."
  whiptail --msgbox "$msg" 18 80
}

build_startup_plan() {
  load_config
  local plan_file desired_file tmp_current
  plan_file="$TWIN_REPO/plan-startup.txt"
  : >"$plan_file"

  if ! command -v crontab >/dev/null 2>&1; then
    echo "$plan_file 0"
    return
  fi

  desired_file="$TWIN_REPO/system/startup/user-crontab.txt"
  if [[ ! -f "$desired_file" ]]; then
    echo "$plan_file 0"
    return
  fi

  tmp_current="$TWIN_REPO/system/startup/.tmp-current-cron"
  if crontab -l >"$tmp_current" 2>/dev/null; then
    if ! cmp -s "$desired_file" "$tmp_current"; then
      echo "UPDATE_USER_CRONTAB $desired_file" >"$plan_file"
      echo "$plan_file 1"
    else
      echo "$plan_file 0"
    fi
  else
    # no current crontab at all -> updating is a change
    echo "UPDATE_USER_CRONTAB $desired_file" >"$plan_file"
    echo "$plan_file 1"
  fi
}

plan_startup_changes() {
  ensure_whiptail
  load_config

  local result plan_file count
  result=$(build_startup_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  count=$(echo "$result" | awk '{print $2}')

  if [[ ! -s "$plan_file" || "$count" -eq 0 ]]; then
    whiptail --msgbox "No startup (user crontab) changes planned." 10 80
    return
  fi

  local msg
  msg="Planned startup change (user crontab):\n\nTwin's user-crontab differs from current crontab.\n\nPlan file:\n$plan_file\n\nThis will replace your current user crontab with the version stored in the twin."
  whiptail --msgbox "$msg" 18 80
}

apply_startup_changes() {
  ensure_whiptail
  load_config

  if ! command -v crontab >/dev/null 2>&1; then
    whiptail --msgbox "Startup apply requires 'crontab' support.\n\nNo changes applied." 10 80
    return
  fi

  local result plan_file count desired_file
  result=$(build_startup_plan)
  plan_file=$(echo "$result" | awk '{print $1}')
  count=$(echo "$result" | awk '{print $2}')

  if [[ ! -s "$plan_file" || "$count" -eq 0 ]]; then
    whiptail --msgbox "No startup changes to apply." 10 80
    return
  fi

  desired_file=$(awk 'NR==1 {print $2}' "$plan_file")

  local confirm_msg
  confirm_msg="About to replace your user crontab with the version stored in:\n$desired_file\n\nThis will overwrite all your current cron jobs for this user.\n\nProceed?"
  if ! whiptail --yesno "$confirm_msg" 20 80; then
    return
  fi

  if crontab "$desired_file" 2>/dev/null; then
    whiptail --msgbox "User crontab updated from twin." 10 60
  else
    whiptail --msgbox "Failed to update user crontab.\n\nCheck file contents and permissions." 12 60
  fi
}

snapshot() {
  ensure_whiptail
  ensure_git
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nUse 'Setup / utilities' → 'Init / configure local Twin repo' first." 10 80
    return
  fi

  collect_system_info
  collect_filesystem_snapshot

  (
    cd "$TWIN_REPO"
    git add .
  )

  local msg
  msg="TwinSync snapshot $(date -Iseconds)"

  if (cd "$TWIN_REPO" && git diff --cached --quiet); then
    whiptail --msgbox "No changes to snapshot.\n\nTwin repo is already up to date." 10 60
    return
  fi

  (
    cd "$TWIN_REPO"
    git commit -m "$msg" >/dev/null 2>&1 || true
  )

  local remotes
  remotes=$(cd "$TWIN_REPO" && git remote 2>/dev/null || true)

  if [[ -n "$remotes" ]]; then
    (
      cd "$TWIN_REPO"
      git push >/dev/null 2>&1 || true
    )
    whiptail --msgbox "Snapshot committed locally.\n\nA 'git push' was attempted to your configured remote.\n\nUse 'git status' in the twin repo for details if needed." 14 80
  else
    whiptail --msgbox "Snapshot committed locally.\n\nNo Git remote is configured yet, so nothing was pushed.\n\nUse 'Setup / utilities' → 'GitHub setup' to wire a private repo for this device." 14 80
  fi
}

pull_changes() {
  ensure_whiptail
  ensure_git
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nUse 'Setup / utilities' → 'Init / configure local Twin repo' first." 10 80
    return
  fi

  local remotes
  remotes=$(cd "$TWIN_REPO" && git remote 2>/dev/null || true)
  if [[ -z "$remotes" ]]; then
    whiptail --msgbox "No Git remote configured.\n\nUse 'Setup / utilities' → 'GitHub setup' to create/link a private repo for this device." 14 80
    return
  fi

  (
    cd "$TWIN_REPO"
    git pull --ff-only >/dev/null 2>&1 || true
  )

  whiptail --msgbox "Pulled latest changes from the remote into the twin repo.\n\nYou can now plan/apply changes so the system follows the updated twin." 16 80
}

time_machine_menu() {
  ensure_whiptail
  ensure_git
  load_config

  if [[ ! -d "$TWIN_REPO/.git" ]]; then
    whiptail --msgbox "Twin repo is not initialized.\n\nUse 'Setup / utilities' → 'Init / configure local Twin repo' first." 10 80
    return
  fi

  local entries
  entries=$(cd "$TWIN_REPO" && git log --pretty=format:'%h %ad %s' --date=short -n 20 2>/dev/null || true)

  if [[ -z "$entries" ]]; then
    whiptail --msgbox "No git history yet in the twin repo.\n\nTake at least one snapshot first." 10 80
    return
  fi

  local menu_args=()
  while IFS= read -r line; do
    local hash rest
    hash=$(echo "$line" | awk '{print $1}')
    rest=$(echo "$line" | cut -d' ' -f2-)
    menu_args+=("$hash" "$rest")
  done <<<"$entries"

  local choice
  choice=$(whiptail --title "TwinSync Time Machine" --menu "Select snapshot to reset twin repo to:" 20 90 10 "${menu_args[@]}" 3>&1 1>&2 2>&3) || return

  local confirm_msg
  confirm_msg="This will reset the twin repo at:\n$TWIN_REPO\n\nto the selected snapshot ($choice) using:\n  git reset --hard $choice\n\nThis only affects the twin repo (not your real system), but it may cause the GitHub remote to diverge and require a force push from the twin repo.\n\nProceed?"
  if ! whiptail --yesno "$confirm_msg" 20 90; then
    return
  fi

  (
    cd "$TWIN_REPO"
    git reset --hard "$choice" >/dev/null 2>&1 || true
  )

  whiptail --msgbox "Twin repo has been reset to snapshot $choice.\n\nYou can now run snapshot/plan/apply to bring the real system in line with this snapshot.\nIf you use GitHub, you may need to push manually from the twin repo." 18 90
}

setup_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync setup" --menu "Prepare the twin and choose what gets mirrored:" 20 90 8 \
      1 "Init / configure local twin repo" \
      2 "Configure filesystem roots to mirror" \
      3 "Link or create GitHub device repo" \
      4 "Install / check dependencies (Debian/Ubuntu)" \
      5 "Update TwinSync program (git pull)" \
      6 "Show current TwinSync config" \
      7 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) init_repo ;;
      2) configure_filesystem_roots ;;
      3) setup_github_device_remote ;;
      4) install_dependencies ;;
      5) update_twinsync_program ;;
      6) show_config ;;
      7) return ;;
    case "$choice" in
      1) init_repo ;;
      2) configure_filesystem_roots ;;
      3) setup_github_device_remote ;;
      4) install_dependencies ;;
      5) update_twinsync_program ;;
      6) show_config ;;
      7) return ;;
    choice=$(whiptail --title "TwinSync setup / utilities" --menu "Choose an action:" 20 80 8 \
      1 "Init / configure local Twin repo (create local Git)" \
      2 "GitHub setup (remember username/token + device repo)" \
      3 "Install/check dependencies (Debian/Ubuntu)" \
      4 "Configure filesystem roots (directories to mirror)" \
      5 "Show current TwinSync config" \
      6 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) init_repo ;;
      2) setup_github_device_remote ;;
      3) install_dependencies ;;
      4) configure_filesystem_roots ;;
      5) show_config ;;
      6) return ;;
    esac
  done
}

snapshot_sync_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync snapshot & sync" --menu "Keep the twin repo up to date or pull from the remote copy:" 18 90 6 \
      1 "Take snapshot (update twin + commit + try push)" \
      2 "Pull from remote (refresh twin repo)" \
      3 "Back" 3>&1 1>&2 2>&3) || return
    choice=$(whiptail --title "TwinSync snapshot / sync" --menu "Choose an action:" 18 90 6 \
      1 "Take snapshot (update twin + commit + optional push)" \
      2 "Pull from remote (update twin repo)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) snapshot ;;
      2) pull_changes ;;
      3) return ;;
    esac
  done
}

plan_apply_menu() {
files_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "Plan & apply changes" --menu "Pick what to reconcile from the twin onto this system:" 20 90 8 \
      1 "Files (plan/apply)" \
      2 "Packages (plan/apply)" \
      3 "Services (plan/apply)" \
      4 "Startup (plan/apply)" \
      5 "Back" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) files_menu ;;
      2) packages_menu ;;
      3) services_menu ;;
      4) startup_menu ;;
      5) return ;;
    choice=$(whiptail --title "TwinSync files" --menu "Choose an action:" 18 90 6 \
      1 "Plan file changes (twin -> system)" \
      2 "Apply file changes (twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_file_changes ;;
      2) apply_file_changes ;;
      3) return ;;
    esac
  done
}

packages_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync packages" --menu "Choose an action:" 18 90 6 \
      1 "Plan package changes (apt, twin -> system)" \
      2 "Apply package changes (apt, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_package_changes ;;
      2) apply_package_changes ;;
      3) return ;;
    esac
  done
}

services_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync services" --menu "Choose an action:" 18 90 6 \
      1 "Plan service changes (systemd, twin -> system)" \
      2 "Apply service changes (systemd, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_service_changes ;;
      2) apply_service_changes ;;
      3) return ;;
    esac
  done
}

startup_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync startup" --menu "Choose an action:" 18 90 6 \
      1 "Plan startup changes (user crontab)" \
      2 "Apply startup changes (user crontab)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_startup_changes ;;
      2) apply_startup_changes ;;
      3) return ;;
    esac
  done
}

files_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync files" --menu "Choose an action:" 18 90 6 \
      1 "Plan file changes (twin -> system)" \
      2 "Apply file changes (twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_file_changes ;;
      2) apply_file_changes ;;
      3) return ;;
    esac
  done
}

packages_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync packages" --menu "Choose an action:" 18 90 6 \
      1 "Plan package changes (apt, twin -> system)" \
      2 "Apply package changes (apt, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_package_changes ;;
      2) apply_package_changes ;;
      3) return ;;
    esac
  done
}

services_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync services" --menu "Choose an action:" 18 90 6 \
      1 "Plan service changes (systemd, twin -> system)" \
      2 "Apply service changes (systemd, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_service_changes ;;
      2) apply_service_changes ;;
      3) return ;;
    esac
  done
}

startup_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync startup" --menu "Choose an action:" 18 90 6 \
      1 "Plan startup changes (user crontab)" \
      2 "Apply startup changes (user crontab)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_startup_changes ;;
      2) apply_startup_changes ;;
      3) return ;;
    esac
  done
}

files_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync files" --menu "Choose an action:" 18 90 6 \
      1 "Plan file changes (twin -> system)" \
      2 "Apply file changes (twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_file_changes ;;
      2) apply_file_changes ;;
      3) return ;;
    esac
  done
}

packages_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync packages" --menu "Choose an action:" 18 90 6 \
      1 "Plan package changes (apt, twin -> system)" \
      2 "Apply package changes (apt, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_package_changes ;;
      2) apply_package_changes ;;
      3) return ;;
    esac
  done
}

services_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync services" --menu "Choose an action:" 18 90 6 \
      1 "Plan service changes (systemd, twin -> system)" \
      2 "Apply service changes (systemd, twin -> system)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_service_changes ;;
      2) apply_service_changes ;;
      3) return ;;
    esac
  done
}

startup_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync startup" --menu "Choose an action:" 18 90 6 \
      1 "Plan startup changes (user crontab)" \
      2 "Apply startup changes (user crontab)" \
      3 "Back to main menu" 3>&1 1>&2 2>&3) || return
    case "$choice" in
      1) plan_startup_changes ;;
      2) apply_startup_changes ;;
      3) return ;;
    esac
  done
}

main_menu() {
  ensure_whiptail
  load_config
  while true; do
    local choice
    choice=$(whiptail --title "TwinSync" --menu "Start with setup, keep the twin in sync, then plan/apply changes:" 20 90 9 \
      1 "Setup (repo, roots, GitHub, deps, config)" \
      2 "Snapshot & sync" \
      3 "Plan & apply changes" \
      4 "Time Machine / history" \
      5 "Exit" 3>&1 1>&2 2>&3) || exit 0
    choice=$(whiptail --title "TwinSync" --menu "Choose an action:" 20 84 10 \
      1 "Setup / utilities" \
      2 "Snapshot / sync" \
      3 "Files (plan/apply)" \
      4 "Packages (plan/apply)" \
      5 "Services (plan/apply)" \
      6 "Startup (plan/apply)" \
      7 "Time Machine / history" \
      8 "Exit" 3>&1 1>&2 2>&3) || exit 0

    case "$choice" in
      1) setup_menu ;;
      2) snapshot_sync_menu ;;
      3) plan_apply_menu ;;
      4) time_machine_menu ;;
      5) exit 0 ;;
      3) files_menu ;;
      4) packages_menu ;;
      5) services_menu ;;
      6) startup_menu ;;
      7) time_machine_menu ;;
      8) exit 0 ;;
    esac
  done
}

# CLI shortcuts for advanced use
if [[ $# -gt 0 ]]; then
  case "$1" in
    init)           init_repo ;;
    push|snapshot)  snapshot ;;
    pull)           pull_changes ;;
    github-setup)   setup_github_device_remote ;;
    plan-files)     plan_file_changes ;;
    apply-files)    apply_file_changes ;;
    plan-packages)  plan_package_changes ;;
    apply-packages) apply_package_changes ;;
    plan-services)  plan_service_changes ;;
    apply-services) apply_service_changes ;;
    plan-startup)   plan_startup_changes ;;
    apply-startup)  apply_startup_changes ;;
    time-machine)   time_machine_menu ;;
    *)
      echo "TwinSync v0.3"
      echo "Usage:"
      echo "  $0                # Launch menu UI"
      echo "  $0 init           # Init twin repo (no menu)"
      echo "  $0 snapshot       # Take snapshot (no menu)"
      echo "  $0 pull           # Pull from remote (no menu)"
      echo "  $0 github-setup   # GitHub credentials + device repo setup"
      echo "  $0 plan-files     # Plan file changes (twin -> system)"
      echo "  $0 apply-files    # Apply file changes (twin -> system)"
      echo "  $0 plan-packages  # Plan apt package changes"
      echo "  $0 apply-packages # Apply apt package changes"
      echo "  $0 plan-services  # Plan systemd service changes"
      echo "  $0 apply-services # Apply systemd service changes"
      echo "  $0 plan-startup   # Plan user crontab changes"
      echo "  $0 apply-startup  # Apply user crontab changes"
      echo "  $0 time-machine   # Git history selection for twin repo"
      exit 1
      ;;
  esac
else
  main_menu
fi
